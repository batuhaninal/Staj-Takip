@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
    Layout = "_StudentLayout";
}

@model InternshipsBook

<div id="placeHolderParent">
    <div id="modalPlaceHolder" aria-hidden="true"></div>
</div>


<div class="container-fluid pt-4 px-4">
    <div class="row g-4">
        <div class="text-center">
            <div class="row">
                <div class="col-6">
                    @if (Model.IsTeacherChecked)
                    {
                        <div class="alert alert-success">
                            Eğitmen Kontrolü Yapıldı!
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-danger">
                            Henüz Eğitmen Kontrolü Yapılmadı!
                        </div>
                    }
                </div>
                <div class="col-6">
                    @if (Model.IsCompanyChecked)
                    {
                        <div class="alert alert-success">
                            Şirket Kontrolü Yapıldı!
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-danger">
                            Henüz Şirket Kontrolü Yapılmadı!
                        </div>
                    }
                </div>
            </div>
        </div>
        <div class="col-sm-12 col-lg-9">
            <div class="bg-light rounded h-100 p-4">
                <form asp-controller="InternshipsBook" asp-action="Page" method="post">
                    <input type="hidden" asp-for="Id" />
                    <input type="hidden" asp-for="StudentUserId" value="@User.Identity.Name" />
                    <div class="form-floating mb-3">
                        <div class="row g-4">
                            <div class="col-lg-6 col-sm-12">
                                <div class="form-group">
                                    <label for="dte">Tarih</label>
                                    <input type="date" class="form-control"
                                           id="dte" asp-for="Date" placeholder="Lütgen tarih giriniz!">
                                    <span class="text-danger" asp-validation-for="Date"></span>
                                </div>

                            </div>
                            @*<div class="col-lg-6 col-sm-12">
                            <div class="form-group">
                            <label for="workD">Çalışma Günleri</label>
                            <input type="text" class="form-control"
                            id="workD" asp-for="WorkDays" placeholder="(örn=12-13)">
                            <span class="text-danger" asp-validation-for="WorkDays"></span>
                            </div>

                            </div>*@
                        </div>
                    </div>
                    @*<div class="form-floating mb-3">
                    <div class="form-group">
                    <label for="titl">Başlık</label>
                    <input type="text" class="form-control"
                    id="titl" asp-for="Title" placeholder="Lütgen Başlık giriniz!">
                    <span class="text-danger" asp-validation-for="Title"></span>
                    </div>

                    </div>*@
                    <div class="form-floating mb-3">
                        <div class="form-group">
                            <label for="cont">İçerik</label>
                            <textarea rows="25" class="ckStudent" asp-for="Content">
                            </textarea>
                            <span class="text-danger" asp-validation-for="Content"></span>
                        </div>

                    </div>
                    @*<div class="form-floating mb-3">
                    <div class="form-group">
                    <label for="summa">Özet</label>
                    <input type="text" class="form-control" id="summa" asp-for="Summary" />
                    <span class="text-danger" asp-validation-for="Summary"></span>
                    </div>

                    </div>*@
                    <button type="submit" class="btn btn-success">Değişiklikleri Kaydet</button>
                    <button id="btnImageAdd" bookId="@Model.Id" type="button" class="btn btn-info">Resim Ekle</button>
                </form>
                <div class="part">
                    @*                @await Component.InvokeAsync("ImageList", new{bookId=Model.Id})*@
                </div>
            </div>
        </div>
        <div class="col-sm-12 col-lg-3">
            @await Component.InvokeAsync("InternshipsBookPagesList")
        </div>
    </div>
</div>


@section Scripts{
    <script src="~/js/ckeditor/ckeditor.js"></script>
    <script src="~/StudentTemplate/js/StudentCK.js"></script>
    <script>
        $(document).ready(function () {
            var placeHolderDiv = $('#modalPlaceHolder');

            refreshList();

            function refreshList() {
                //deletePlaceHolder();
                //createPlaceholder();
                var refreshListUrl = `/InternshipsBook/ImageList?bookId=${@Model.Id}`;
                $.get(refreshListUrl).done(function (data) {
                    var divPart = $('.part');
                    divPart.html(data);
                });
            }

            function createPlaceholder() {
                let placeDiv = `<div id="modalPlaceHolder" aria-hidden="true"></div>`;
                $('#placeHolderParent').html(placeDiv);
            }

            function deletePlaceHolder() {
                $('#modalPlaceHolder').remove();
            }


            // Image show popup
            $(document).on('click', '.btnShowImage', function () {
                var imageId = $(this).attr('imageId');
                const imageUrl = `/InternshipsBook/ImageShowPopup?imageId=${imageId}`;
                $.get(imageUrl).done(function (data) {
                    placeHolderDiv.html(data);
                    placeHolderDiv.find('.modal').modal('show');
                })
                    .done(function () {
                        let deletePostCount = 0;
                        placeHolderDiv.on('click', '#btnDelete', function () {
                            deletePostCount++;
                            if(deletePostCount>1){

                            }else{
                                $.ajax({
                                    type: 'post',
                                    url: `/InternshipsBook/DeleteImage?imageId=${imageId}`,
                                    success: function () {
                                        alert("success");
                                        refreshList();
                                        closeModal();
                                    }
                                })
                            }
                        });
                    });
            });






            // Image Add Popup

            $('#btnImageAdd').on('click', function (event) {
                event.preventDefault();
                var bookIdGet = $(this).attr('bookId');
                const url = `/InternshipsBook/AddImagePopup?bookId=${bookIdGet}`;
                debugger;
                $.get(url).done(function (data) {
                    placeHolderDiv.html(data);
                    placeHolderDiv.find('.modal').modal('show');
                });

                let count = 0;

                placeHolderDiv.on('click', '#postImage', function (e) {
                    e.preventDefault();
                    count++;
                    if (count > 1) {

                    } else {
                        const form = $('#imageForm');
                        const dataToSend = new FormData(form.get(0));
                        var postUrl = '/InternshipsBook/AddImagePopup';
                        $.ajax({
                            type: 'post',
                            data: dataToSend,
                            url: postUrl,
                            processData: false,
                            contentType: false,
                            success: function (func) {
                                alert('success');
                                refreshList();
                                closeModal();
                            }
                        });
                    }
                });


                function closeModal(){
                    placeHolderDiv.find('.modal').modal('hide');
                }
            });
        });
    </script>
}

